<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="manifest" href="/Pitch-Matching-Trainer/manifest.webmanifest"/>
  <title>Pitch Matching Trainer</title>

  <style>
    :root{
      --bg:#f4f4f4;
      --card:#f7f7f7;
      --fg:#222;
      --muted:#666;
      --border:#c8c8c8;
      --shadow:0 1px 8px rgba(0,0,0,.08);
      --radius:18px;
      --design-width:470px;
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      overflow:hidden;
      overscroll-behavior:none;
      touch-action: manipulation;
    }

    .row > * { min-width:0; }
    .controls > * { min-width:0; }
    input, select, button { min-width:0; }

    body{
      background:var(--bg);
      color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:.75rem;
      display:flex;
      justify-content:flex-start;
      overflow:hidden;
    }

    .appScale{
      width:470px;
      transform-origin:top left;
    }

    .wrap{
      width:470px;
      padding:10px 0 20px;
    }

    h1{
      text-align:center;
      margin:4px 0 12px;
      font-size:1.4rem;
      line-height:1.15;
    }

    .card{
      background:var(--card);
      border:1.5px solid var(--border);
      border-radius: var(--radius);
      padding: .8rem;
      box-shadow: var(--shadow);
    }

    form#settings{
      display:flex;
      flex-direction:column;
      gap:.45rem;
    }

    .row{
      display:grid;
      grid-template-columns: 5.5rem 1fr;
      gap:.45rem;
      align-items:center;
    }

    label{
      opacity:.85;
      user-select:none;
      white-space:nowrap;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:.45rem;
      flex-wrap:nowrap;
      white-space:nowrap;
    }

    .sub{
      opacity:.75;
      user-select:none;
      white-space:nowrap;
    }

    select, input, button{
      font: inherit;
      font-size: 1rem;
      padding: .28rem .5rem;
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      height: 2.15rem;
      outline:none;
    }
    select:focus, input:focus, button:focus{
      box-shadow: 0 0 0 3px rgba(0,0,0,.06);
    }

    input[type="number"]{
      width: calc(4ch + 1.9rem);
      flex: 0 0 calc(4ch + 1.9rem);
      text-align: right;
    }

    input[type="text"]{
      flex: 0 0 14.5rem;
      width: 14.5rem;
      min-width: 14.5rem;
      max-width: 14.5rem;
    }

    #upIntervals, #downIntervals{
      flex: 1 1 auto;
      width: 100%;
      min-width: 0;
      max-width: none;
    }

    #tuningInput, #soundInput, #repeatInput, #centMax{
      width: calc(5ch + 2rem);
      flex: 0 0 calc(5ch + 2rem);
    }
    #tolInput, #centMin{
      width: calc(4ch + 1.8rem);
      flex: 0 0 calc(4ch + 1.8rem);
    }
    #transposeInput, #shiftInputChr, #shiftInputDia{
      width: calc(4ch + 1.8rem);
      flex: 0 0 calc(4ch + 1.8rem);
    }

    .controls select{
      flex: 0 0 5.7rem;
      width: 5.7rem;
      min-width: 5.7rem;
      padding: .24rem .44rem;
    }
    #rangeLow, #rangeHigh{ min-width: 4.3rem; }
    #jumpMin, #jumpMax{ min-width: 4.6rem; }

    .dash{
      opacity:.6;
      padding: 0 .1rem;
      user-select:none;
      white-space:nowrap;
    }

    .group{
      display:flex;
      align-items:center;
      gap:.25rem;
      white-space:nowrap;
      flex: 0 0 auto;
    }

    .group input{
      flex: 0 0 auto;
      min-width: 0;
    }

    .unit{
      opacity:1;
      color:var(--fg);
      user-select:none;
      white-space:nowrap;
    }

    .row4{
      display:grid;
      grid-template-columns: 5.5rem 6.6rem 3.9rem 6.6rem;
      gap:.45rem;
      align-items:center;
    }
    #tuningRow{
      grid-template-columns: 5.5rem 6.6rem 5.2rem 6.2rem;
    }
    #shiftRow{
      grid-template-columns: 5.5rem 7.2rem 3.2rem 6.2rem;
    }

    hr.sep{
      border:none;
      border-top:1px solid var(--border);
      margin:.35rem 0 .2rem;
    }

    .actions{
      display:flex;
      gap:.6rem;
      width:100%;
      margin-top:.5rem;
    }

    button{
      cursor:pointer;
      background:#eee;
      color:var(--fg);
      border:1px solid var(--border);
      -webkit-appearance:none;
      appearance:none;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    button.primary{
      font-weight:700;
      width:100%;
      flex:1 1 auto;
    }
    #tonicBtn{
      min-width: 6.4rem;
      flex: 0 0 auto;
    }
    button:active{ transform:scale(.98); }

    .hidden{ display:none !important; }

    #lastNote{
      font-size:1.5rem;
      font-weight:800;
      min-height:1.6em;
      display:flex;
      align-items:center;
      margin:.65rem 0 .2rem;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.25rem .85rem;
      margin-top:.45rem;
    }
    .stat{
      display:flex;
      justify-content:space-between;
      gap:.6rem;
      align-items:baseline;
    }
    .k{ opacity:.75; }
    .v{ font-weight:800; }

    .debugWrap{
      margin-top:.45rem;
      border-top:1px dashed var(--border);
      padding-top:.4rem;
    }
    .debugToggle{
      background:#f2f2f2;
      font-size:.92rem;
      padding:.2rem .5rem;
      height:1.9rem;
    }
    .debugGrid{
      margin-top:.35rem;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.18rem .7rem;
      font-size:.88rem;
    }
    .debugRow{
      display:flex;
      justify-content:space-between;
      gap:.55rem;
      font-variant-numeric: tabular-nums;
    }
    .debugK{ opacity:.75; }
    .debugV{ font-weight:700; }

    .modeSettings{
      margin-top: .15rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .65rem;
      background: rgba(0,0,0,.02);
      display:flex;
      flex-direction:column;
      gap:.45rem;
    }

    .modeSettings .subpanel{
      border:none;
      padding:0;
      margin:0;
      background:transparent;
      display:flex;
      flex-direction:column;
      gap:.45rem;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{
      position:absolute;
      opacity:0;
      width:1px;
      height:1px;
      pointer-events:none;
    }
    .toggle .track{
      width: 2.55rem;
      height: 1.45rem;
      border-radius: 999px;
      background:#e2e2e2;
      border:1px solid var(--border);
      position:relative;
      transition: background .15s ease, border-color .15s ease;
      flex: 0 0 auto;
    }
    .toggle .thumb{
      width: 1.15rem;
      height: 1.15rem;
      border-radius: 999px;
      background:#fff;
      position:absolute;
      top:50%;
      left:.14rem;
      transform: translateY(-50%);
      box-shadow: 0 1px 3px rgba(0,0,0,.18);
      transition: left .15s ease;
    }
    .toggle input:checked + .track{
      background:#cfcfcf;
      border-color:#b7b7b7;
    }
    #shiftRow .toggle input:checked + .track{
      background:#e2e2e2;
      border-color:var(--border);
    }
    .toggle input:checked + .track .thumb{
      left: calc(100% - 1.29rem);
    }
    .toggleState{
      opacity:.8;
      min-width: 2.2rem;
      text-align:left;
      white-space:nowrap;
    }

    #tuner{
      margin:.15rem 0 .35rem;
    }
    .tuner-bar{
      position:relative;
      height:14px;
      background:#ddd;
      border-radius:999px;
      overflow:hidden;
    }
    .tuner-center{
      position:absolute;
      left:50%;
      top:0;
      bottom:0;
      width:2px;
      background:#666;
      opacity:.6;
      transform:translateX(-50%);
    }
    .tuner-needle{
      position:absolute;
      top:-6px;
      left:50%;
      width:2px;
      height:26px;
      background:#222;
      transform:translateX(-50%);
      transition:left 80ms linear, background 120ms, opacity 120ms;
      opacity:1;
    }
    .tuner-needle.good{ background:#2a8f2a; }
    .tuner-needle.off{ opacity:0; }
    .tuner-readout{
      text-align:center;
      margin-top:.35rem;
      font-weight:800;
      font-variant-numeric: tabular-nums;
      opacity:.85;
      min-height: 1.2em;
    }
  </style>
</head>

<body>
  <div class="appScale" id="appScale">
    <div class="wrap">
      <h1>Pitch Matching Trainer</h1>

      <div class="card">
        <form id="settings" autocomplete="off">
          <div class="row4" id="tuningRow">
            <label>Tuning</label>
            <span class="group">
              <input id="tuningInput" type="number" value="440"/>
              <span class="unit">Hz</span>
            </span>
            <span class="sub">Transpose</span>
            <span class="group">
              <input id="transposeInput" type="number" value="0" step="1"/>
              <span class="unit">st</span>
            </span>
          </div>

          <hr class="sep"/>

          <div class="row">
            <label for="rangeLow">Range</label>
            <div class="controls">
              <select id="rangeLow"></select>
              <span class="dash">-</span>
              <select id="rangeHigh"></select>
            </div>
          </div>

          <div class="row">
            <label for="intervalMode">Mode</label>
            <div class="controls">
              <select id="intervalMode">
                <option value="minmax">Min-Max</option>
                <option value="lists">Intervals</option>
                <option value="tonal">Tonal</option>
                <option value="continuous">Continuous</option>
              </select>
              <select id="symmetrySelect" class="hidden">
                <option value="1">Symmetric</option>
                <option value="0">Asymmetric</option>
              </select>
            </div>
          </div>

          <div class="modeSettings" aria-label="Mode settings">
            <div id="intervalMinMaxRow" class="row">
              <label>Interval</label>
              <div class="controls">
                <select id="jumpMin"></select>
                <span class="dash">-</span>
                <select id="jumpMax"></select>
              </div>
            </div>

            <div id="continuousRow" class="row hidden">
              <label>Interval</label>
              <div class="controls">
                <span class="group">
                  <input id="centMin" type="number" value="20"/>
                  <span class="unit">¢</span>
                </span>
                <span class="dash">-</span>
                <span class="group">
                  <input id="centMax" type="number" value="1200"/>
                  <span class="unit">¢</span>
                </span>
              </div>
            </div>

            <div id="intervalListsRow" class="subpanel hidden">
              <div class="row">
                <label id="upIntervalsLabel" for="upIntervals">Intervals ↑</label>
                <div class="controls">
                  <input id="upIntervals" type="text" value="0 1 2 3 4 5 6 7 8 9 10 11"/>
                </div>
              </div>

              <div id="downIntervalsRow" class="row hidden">
                <label for="downIntervals">Intervals↓</label>
                <div class="controls">
                  <input id="downIntervals" type="text" value="0 1 2 3 4 5 6 7 8 9 10 11"/>
                </div>
              </div>
            </div>

            <div id="tonalRow1" class="row hidden">
              <label for="rootPc">Root</label>
              <div class="controls">
                <select id="rootPc"></select>
              </div>
            </div>

            <div id="tonalRow2" class="row hidden">
              <label for="tonalDegrees">Degrees</label>
              <div class="controls">
                <input id="tonalDegrees" type="text" value="0 2 4 5 7 9 11"/>
              </div>
            </div>
          </div>

          <hr class="sep"/>

          <div class="row4" id="shiftRow">
            <label for="shiftInputChr">Offset</label>
            <span id="shiftTypeWrap" class="group">
              <span class="sub">Chr</span>
              <label class="toggle" title="Offset type: Chr or Dia">
                <input id="shiftType" type="checkbox"/>
                <span class="track" aria-hidden="true"><span class="thumb"></span></span>
              </label>
              <span class="sub">Dia</span>
            </span>
            <span class="group">
              <span id="shiftChrWrap" class="group">
                <input id="shiftInputChr" type="number" value="0" step="1"/>
                <span class="unit">st</span>
              </span>
              <span id="shiftDiaWrap" class="group hidden">
                <input id="shiftInputDia" type="number" value="1" step="1"/>
                <span class="unit">deg</span>
              </span>
            </span>
            <span></span>
          </div>

          <div class="row4" id="tolReplayRow">
            <label>Tolerance</label>
            <span class="group">
              <input id="tolInput" type="number" value="25"/>
              <span class="unit">¢</span>
            </span>
            <span class="sub">Replay</span>
            <label class="toggle" title="Replay the target tone after a correct hit">
              <input id="replayToggle" type="checkbox"/>
              <span class="track" aria-hidden="true"><span class="thumb"></span></span>
              <span id="replayState" class="toggleState">off</span>
            </label>
          </div>

          <div class="row4" id="soundRepeatRow">
            <label>Sound</label>
            <span class="group">
              <input id="soundInput" type="number" value="1000"/>
              <span class="unit">ms</span>
            </span>
            <span class="sub">Repeat</span>
            <span class="group">
              <input id="repeatInput" type="number" value="2000"/>
              <span class="unit">ms</span>
            </span>
          </div>
        </form>

        <div class="actions">
          <button id="toggleBtn" class="primary" type="button">Start</button>
          <button id="tonicBtn" class="hidden" type="button">Tonic</button>
        </div>

        <section aria-live="polite">
          <div id="lastNote">-</div>

          <div id="tuner" aria-hidden="false">
            <div class="tuner-bar">
              <div class="tuner-center"></div>
              <div id="tunerNeedle" class="tuner-needle off"></div>
            </div>
            <div id="tunerReadout" class="tuner-readout">-</div>
          </div>

          <div class="stats">
            <div class="stat"><span class="k">Time:</span><span class="v"><span id="elapsed">0</span>s</span></div>
            <div class="stat"><span class="k">Correct:</span><span class="v"><span id="correct">0</span></span></div>
            <div class="stat"><span class="k">Note:</span><span class="v"><span id="noteTime">0</span>s</span></div>
            <div class="stat"><span class="k">Avg:</span><span class="v"><span id="avgNote">0.00</span>s</span></div>
          </div>

          <div id="debugWrap" class="debugWrap">
            <button id="debugToggleBtn" class="debugToggle" type="button">Debug</button>
            <div id="debugPanel" class="debugGrid hidden">
              <div class="debugRow"><span class="debugK">Freq Hz</span><span id="dbgFreq" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Goal Hz</span><span id="dbgGoal" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Diff ¢</span><span id="dbgDiff" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Clarity</span><span id="dbgClarity" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">dBFS</span><span id="dbgDb" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Tol ¢</span><span id="dbgTol" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Loud</span><span id="dbgLoud" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Clear</span><span id="dbgClear" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Has In</span><span id="dbgHasInput" class="debugV">-</span></div>
              <div class="debugRow"><span class="debugK">Mode</span><span id="dbgMode" class="debugV">-</span></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("/Pitch-Matching-Trainer/sw.js");
      });
    }
  </script>

  <script>
    (function(){
      document.addEventListener("gesturestart", function(e){ e.preventDefault(); }, { passive:false });
      document.addEventListener("dblclick", function(e){ e.preventDefault(); }, { passive:false });

      let lastTouchEnd = 0;
      document.addEventListener("touchend", function(e){
        const now = Date.now();
        if(now - lastTouchEnd <= 300){
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive:false });
    })();
  </script>

  <script>
    (function(){
      const DESIGN = 470;
      const el = document.getElementById("appScale");

      function getHorizontalBodyPaddingPx(){
        const cs = getComputedStyle(document.body);
        const pl = parseFloat(cs.paddingLeft) || 0;
        const pr = parseFloat(cs.paddingRight) || 0;
        return pl + pr;
      }

      function applyScale(s){
        if (window.CSS && CSS.supports && CSS.supports("zoom", "1")) {
          el.style.zoom = String(s);
          el.style.transform = "";
        } else {
          el.style.zoom = "";
          el.style.transform = `scale(${s})`;
        }
      }

      function scale(){
        if (!el) return;
        const pad = getHorizontalBodyPaddingPx();
        const avail = Math.max(0, window.innerWidth - pad);
        const s = Math.min(1, avail / DESIGN);
        applyScale(s);
      }

      window.addEventListener("resize", scale, { passive:true });
      window.addEventListener("load", scale);
      scale();
    })();
  </script>
</body>
</html>
